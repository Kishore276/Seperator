<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Plant Classification System</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(to right, #00c6ff, #0072ff);
        color: #fff;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px 0;
      }

      .container {
        max-width: 800px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
        animation: fadeIn 1s ease-in-out;
      }

      h2 {
        font-size: 2.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
      }

      .form-control {
        border-radius: 10px;
        border: 1px solid #ddd;
        padding: 10px;
        font-size: 1rem;
        margin-top: 10px;
      }

      .btn {
        border: none;
        padding: 10px 20px;
        font-size: 1.1rem;
        border-radius: 50px;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn-primary {
        background-color: #0072ff;
        box-shadow: 0 8px 16px rgba(0, 114, 255, 0.3);
      }

      .btn-primary:hover {
        background-color: #005bcc;
        box-shadow: 0 8px 24px rgba(0, 91, 204, 0.4);
      }

      .btn-danger {
        background-color: #ff4d4d;
        box-shadow: 0 8px 16px rgba(255, 77, 77, 0.3);
      }

      .btn-danger:hover {
        background-color: #ff1a1a;
        box-shadow: 0 8px 24px rgba(255, 26, 26, 0.4);
      }

      .btn-success {
        background-color: #28a745;
        box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
      }

      .btn-success:hover {
        background-color: #218838;
        box-shadow: 0 8px 24px rgba(33, 136, 56, 0.4);
      }

      .result-container {
        margin-top: 30px;
        padding: 20px;
        background-color: #f1f1f1;
        border-radius: 15px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        display: none;
      }

      .camera-container {
        margin-top: 20px;
        display: none;
      }

      #video {
        width: 100%;
        max-width: 500px;
        height: auto;
        border-radius: 10px;
        border: 3px solid #0072ff;
      }

      #canvas {
        display: none;
      }

      .capture-preview {
        margin-top: 15px;
        width: 100%;
        max-width: 400px;
        height: auto;
        border-radius: 8px;
        border: 2px solid #28a745;
        display: none;
      }

      .input-methods {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      .method-btn {
        margin: 0 10px;
        padding: 10px 20px;
        font-size: 1rem;
        cursor: pointer;
        background-color: #f1f1f1;
        color: #333;
        border-radius: 8px;
        border: 2px solid #ddd;
        transition: all 0.3s;
      }

      .method-btn.active {
        background-color: #0072ff;
        color: white;
        border-color: #0072ff;
      }

      .result-image {
        width: 100%;
        max-width: 400px;
        height: auto;
        border-radius: 8px;
        margin-top: 15px;
      }

      .not-weed {
        color: #28a745;
        font-weight: 600;
        font-size: 1.5rem;
        margin-top: 20px;
      }

      .weed {
        color: #dc3545;
        font-weight: 600;
        font-size: 1.5rem;
        margin-top: 20px;
      }

      .alert {
        padding: 10px;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 10px;
      }

      .result-info p {
        font-size: 1.1rem;
        margin: 8px 0;
        color: #000 !important;
        font-weight: 600 !important;
        background: rgba(255, 255, 255, 0.95) !important;
        padding: 12px !important;
        border-radius: 8px;
        border-left: 4px solid #0072ff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        line-height: 1.4;
      }

      .correction-note {
        background: rgba(255, 193, 7, 0.2) !important;
        border-left: 4px solid #ffc107 !important;
        color: #000 !important;
        font-weight: 700 !important;
        box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3) !important;
      }

      .crop-result {
        border-left: 4px solid #28a745 !important;
        background: rgba(40, 167, 69, 0.1) !important;
        color: #000 !important;
        font-weight: 700 !important;
      }

      .weed-result {
        border-left: 4px solid #dc3545 !important;
        background: rgba(220, 53, 69, 0.1) !important;
        color: #000 !important;
        font-weight: 700 !important;
      }

      .result-header {
        font-size: 1.4rem;
        margin-bottom: 20px;
        font-weight: 700;
        text-align: left;
        color: #000 !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      }

      @keyframes fadeIn {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      
      .loading-spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #0072ff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Enhanced text visibility */
      .result-info strong {
        color: #000 !important;
        font-weight: 800 !important;
      }

      .result-info {
        color: #000 !important;
      }

      .alert-success {
        color: #000 !important;
        background-color: rgba(212, 237, 218, 0.9) !important;
        border-color: #28a745 !important;
        font-weight: 600 !important;
      }

      .alert-danger {
        color: #000 !important;
        background-color: rgba(248, 215, 218, 0.9) !important;
        border-color: #dc3545 !important;
        font-weight: 600 !important;
      }

      /* Ensure all text in results is visible */
      #result * {
        color: #000 !important;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>🌱 Advanced Plant Classification System</h2>
      <p style="color: #666; font-size: 1.1rem; margin-bottom: 25px;">
        Identify crops and weeds worldwide with AI-powered analysis
      </p>
      
      <div class="input-methods">
        <div class="method-btn active" id="uploadBtn">Upload Image</div>
        <div class="method-btn" id="cameraBtn">Use Camera</div>
      </div>
      
      <!-- Upload Method -->
      <div id="uploadMethod">
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="form-group">
            <label for="file">Upload an image of a plant:</label>
            <input
              type="file"
              class="form-control"
              id="file"
              name="file"
              accept="image/*"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">
            Classify Plant
          </button>
        </form>
      </div>
      
      <!-- Camera Method -->
      <div id="cameraMethod" class="camera-container">
        <div class="form-group">
          <label>Take a photo of a plant:</label>
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas"></canvas>
          <img id="capturePreview" class="capture-preview" alt="Captured image" />
        </div>
        <div class="camera-buttons">
          <button id="captureBtn" class="btn btn-danger">Capture Photo</button>
          <button id="recaptureBtn" class="btn btn-primary" style="display: none;">Retake Photo</button>
          <button id="classifyBtn" class="btn btn-success" style="display: none;">Classify Plant</button>
        </div>
      </div>
      
      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>Analyzing image...</p>
      </div>

      <div id="result" class="result-container"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        // Method selection
        $("#uploadBtn").click(function() {
          $(this).addClass("active");
          $("#cameraBtn").removeClass("active");
          $("#uploadMethod").show();
          $("#cameraMethod").hide();
          stopCamera();
        });
        
        $("#cameraBtn").click(function() {
          $(this).addClass("active");
          $("#uploadBtn").removeClass("active");
          $("#uploadMethod").hide();
          $("#cameraMethod").show();
          startCamera();
        });
        
        // Camera functionality
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturePreview = document.getElementById('capturePreview');
        const captureBtn = document.getElementById('captureBtn');
        const recaptureBtn = document.getElementById('recaptureBtn');
        const classifyBtn = document.getElementById('classifyBtn');
        let stream = null;
        
        async function startCamera() {
          try {
            stream = await navigator.mediaDevices.getUserMedia({ 
              video: { 
                facingMode: { ideal: "environment" } // Prefer back camera
              } 
            });
            video.srcObject = stream;
            $("#cameraMethod").show();
          } catch (err) {
            alert("Error accessing camera: " + err.message);
            $("#uploadBtn").click(); // Fall back to upload method
          }
        }
        
        function stopCamera() {
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
          }
        }
        
        // Capture photo
        captureBtn.addEventListener('click', function() {
          const context = canvas.getContext('2d');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          capturePreview.src = canvas.toDataURL('image/jpeg');
          capturePreview.style.display = 'block';
          
          captureBtn.style.display = 'none';
          recaptureBtn.style.display = 'inline-block';
          classifyBtn.style.display = 'inline-block';
        });
        
        // Retake photo
        recaptureBtn.addEventListener('click', function() {
          capturePreview.style.display = 'none';
          captureBtn.style.display = 'inline-block';
          recaptureBtn.style.display = 'none';
          classifyBtn.style.display = 'none';
        });
        
        // Classify captured photo
        classifyBtn.addEventListener('click', function() {
          // Convert canvas data to blob
          canvas.toBlob(function(blob) {
            const formData = new FormData();
            formData.append('file', blob, 'capture.jpg');
            
            $("#loading").show();
            
            $.ajax({
              url: "/predict",
              type: "POST",
              data: formData,
              processData: false,
              contentType: false,
              success: function(response) {
                $("#loading").hide();
                displayResult(response);
              },
              error: function(xhr, status, error) {
                $("#loading").hide();
                $("#result").show();
                $("#result").html(
                  '<div class="alert alert-danger">An error occurred: ' + error + '</div>'
                );
              }
            });
          }, 'image/jpeg', 0.95);
        });

        // Upload form submission
        $("#uploadForm").on("submit", function (event) {
          event.preventDefault();
          var formData = new FormData(this);
          
          $("#loading").show();
          
          $.ajax({
            url: "/predict",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              $("#loading").hide();
              displayResult(response);
            },
            error: function (xhr, status, error) {
              $("#loading").hide();
              $("#result").show();
              $("#result").html(
                '<div class="alert alert-danger">An error occurred: ' + error + '</div>'
              );
            },
          });
        });
        
        // Display result function
        function displayResult(response) {
          $("#result").show();
          
          if (response.error) {
            $("#result").html(
              '<div class="alert alert-danger">' + response.error + '</div>'
            );
          } else {
            var resultHtml = '<div class="result-header">Plant Classification Result:</div>';
            
            // Handle multiple plants (both crops and weeds)
            if (response.hasMultiplePlants) {
              resultHtml += '<div class="alert alert-info">' + response.message + '</div>';
              
              // Display ML model prediction if available
              if (response.ml_prediction) {
                resultHtml += '<div style="background: #e8f4fd; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #17a2b8;">';
                resultHtml += '<h5 style="color: #17a2b8; margin-bottom: 10px;">🤖 ML Model Prediction:</h5>';
                resultHtml += '<p><strong>Class:</strong> ' + response.ml_prediction.class + '</p>';
                resultHtml += '<p><strong>Confidence:</strong> ' + response.ml_prediction.confidence + '</p>';
                resultHtml += '</div>';
              }
              
              // Display crops
              if (response.crops && response.crops.length > 0) {
                resultHtml += '<h4 style="color: #28a745; margin-top: 20px;">🌾 Crops/Beneficial Plants Found:</h4>';
                response.crops.forEach(function(crop, index) {
                  resultHtml += '<div style="background: #f8fff8; padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #28a745;">';
                  resultHtml += '<p><strong>Plant ' + (index + 1) + ':</strong> ' + crop.name + '</p>';
                  resultHtml += '<p><strong>Confidence:</strong> ' + crop.confidence.toFixed(2) + '%</p>';
                  resultHtml += '</div>';
                });
              }
              
              // Display weeds
              if (response.weeds && response.weeds.length > 0) {
                resultHtml += '<h4 style="color: #dc3545; margin-top: 20px;">🌿 Weeds Found:</h4>';
                response.weeds.forEach(function(weed, index) {
                  resultHtml += '<div style="background: #fff8f8; padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #dc3545;">';
                  resultHtml += '<p><strong>Weed ' + (index + 1) + ':</strong> ' + weed.name + '</p>';
                  resultHtml += '<p><strong>Common Name:</strong> ' + weed.common_name + '</p>';
                  resultHtml += '<p><strong>Scientific Name:</strong> <em>' + weed.scientific_name + '</em></p>';
                  resultHtml += '<p><strong>Confidence:</strong> ' + weed.confidence.toFixed(2) + '%</p>';
                  resultHtml += '<p><strong>Control Measure:</strong> ' + weed.control_measure + '</p>';
                  resultHtml += '<p><strong>Climate:</strong> ' + weed.climate + '</p>';
                  resultHtml += '<p><strong>Additional Info:</strong> ' + weed.additional_info + '</p>';
                  resultHtml += '</div>';
                });
              }
            } else {
              // Single plant identification (existing logic)
              resultHtml += '<p><strong>Plant Name:</strong> ' + response.PlantName + '</p>';
              
              // Display ML model prediction if available
              if (response.ml_prediction) {
                resultHtml += '<div style="background: #e8f4fd; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #17a2b8;">';
                resultHtml += '<h5 style="color: #17a2b8; margin-bottom: 10px;">🤖 ML Model Prediction:</h5>';
                resultHtml += '<p><strong>Class:</strong> ' + response.ml_prediction.class + '</p>';
                resultHtml += '<p><strong>Confidence:</strong> ' + response.ml_prediction.confidence + '</p>';
                resultHtml += '</div>';
              }
              
              // Display both common name and scientific name if available
              if (response.CommonName && response.ScientificName) {
                resultHtml += '<p><strong>Common Name:</strong> ' + response.CommonName + '</p>';
                resultHtml += '<p><strong>Scientific Name:</strong> <em>' + response.ScientificName + '</em></p>';
              }
              
              resultHtml += '<p><strong>Confidence:</strong> ' + response.Confidence + '</p>';

              // Display correction note if available
              if (response.CorrectionNote) {
                resultHtml += '<div style="background: rgba(255, 193, 7, 0.1); padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #ffc107; color: #856404;">';
                resultHtml += '<p><strong>⚠️ AI Correction:</strong> ' + response.CorrectionNote + '</p>';
                resultHtml += '</div>';
              }

              // Display family and origin if available
              if (response.Family) {
                resultHtml += '<p><strong>Family:</strong> ' + response.Family + '</p>';
              }
              if (response.Origin) {
                resultHtml += '<p><strong>Origin:</strong> ' + response.Origin + '</p>';
              }

              if (response.isWeed) {
                resultHtml += '<p class="weed">This is a weed!</p>';
                resultHtml += '<div class="result-info">';
                
                if (response.ControlMeasure) {
                  resultHtml += '<p><strong>Control Measure:</strong> ' + response.ControlMeasure + '</p>';
                }
                
                if (response.Climate) {
                  resultHtml += '<p><strong>Climate:</strong> ' + response.Climate + '</p>';
                }
                
                if (response.AdditionalInfo) {
                  resultHtml += '<p><strong>Additional Info:</strong> ' + response.AdditionalInfo + '</p>';
                }
                
                if (response.MoreDetails) {
                  resultHtml += '<p><strong>More Details:</strong> ' + response.MoreDetails + '</p>';
                }
                
                resultHtml += '</div>';
              } else if (response.isCrop) {
                resultHtml += '<p class="crop" style="color: #28a745; font-weight: bold;">🌾 This is a crop!</p>';
                resultHtml += '<div class="result-info" style="border-left: 4px solid #28a745;">';

                if (response.CultivationInfo) {
                  resultHtml += '<p><strong>Cultivation Info:</strong> ' + response.CultivationInfo + '</p>';
                }

                if (response.Climate) {
                  resultHtml += '<p><strong>Climate:</strong> ' + response.Climate + '</p>';
                }

                if (response.IdentificationTips) {
                  resultHtml += '<p><strong>Identification Tips:</strong> ' + response.IdentificationTips + '</p>';
                }

                if (response.AdditionalInfo) {
                  resultHtml += '<p><strong>Additional Info:</strong> ' + response.AdditionalInfo + '</p>';
                }

                if (response.EconomicImpact) {
                  resultHtml += '<p><strong>Economic Impact:</strong> ' + response.EconomicImpact + '</p>';
                }

                if (response.GlobalDistribution) {
                  resultHtml += '<p><strong>Global Distribution:</strong> ' + response.GlobalDistribution + '</p>';
                }

                resultHtml += '</div>';
              } else {
                resultHtml += '<p class="not-weed">This is not a weed.</p>';
                resultHtml += '<p>' + response.Message + '</p>';
              }
            }

            resultHtml += '<img src="' + response.ImagePath + '" class="result-image" alt="Analyzed Plant Image">';
            $("#result").html(resultHtml);
          }
          
          // Scroll to result
          $('html, body').animate({
            scrollTop: $("#result").offset().top - 20
          }, 500);
        }
      });
    </script>
  </body>
</html>